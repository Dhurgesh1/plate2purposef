<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plate2Purpose - Feedback Dashboard</title>
    <link rel="icon" href="images/recycle-sign.png" type="image/png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Playfair+Display&family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background-color: #fff5f0;
        padding-top: 130px;
      }

      .navbar {
        height: 100px;
        background-color: #ffe0d0;
      }

      .navbar-brand {
        font-family: "Amatic SC", cursive;
        font-size: 32px;
        font-weight: 700;
        color: #ff5500 !important;
      }

      .navbar-heading {
        font-size: 20px;
        font-weight: 600;
        margin-left: auto;
        color: #cb7575;
      }

      .sidebar {
        position: fixed;
        top: 110px;
        left: 10px;
        width: 200px;
        height: 550px;
        background-color: #fff;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-radius: 20px;
      }

      .sidebar a {
        display: block;
        padding: 10px;
        color: #cb7575;
        text-decoration: none;
        margin-bottom: 10px;
        border-radius: 10px;
        font-weight: 500;
        border: 2px solid #cb7575;
        text-align: center;
        transition: 0.3s ease;
      }

      .sidebar a:hover,
      .sidebar a.active {
        background-color: #ffaaa0;
        color: white;
      }

      .main-content {
        margin-left: 230px;
        padding: 10px;
      }

      .card {
        border-radius: 14px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        max-width: 500px;
        margin: 10px auto;
      }

      .rating-stars {
        color: #ffc107;
      }

      .card-text.truncated {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #feedbackList {
        --bs-gutter-x: 0.5rem;
        --bs-gutter-y: 0.5rem;
      }

      .preloader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #fff5f0;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
        z-index: 2000;
      }

      .spinner-rotate img {
        animation: spin-pulse 2s linear infinite;
      }

      @keyframes spin-pulse {
        0% {
          transform: rotate(0deg) scale(1);
        }
        50% {
          transform: rotate(180deg) scale(1.2);
        }
        100% {
          transform: rotate(360deg) scale(1);
        }
      }
    </style>
  </head>
  <body>
    <section class="preloader" id="preloader">
      <div class="spinner-rotate">
        <img
          src="images/recycle-sign.png"
          alt="Loading..."
          width="60"
          height="60"
        />
      </div>
    </section>

    <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
      <div class="container">
        <a
          href="admin dashboard.html"
          class="navbar-brand mx-auto mx-lg-0"
          style="
            font-family: 'Amatic SC', cursive;
            font-size: 32px;
            font-weight: 700;
          "
        >
          <span style="color: #ff5500">Plate </span
          ><span class="brand-icon" style="color: #ff5500">2♻️</span
          ><span style="color: #ff5500">Purpose</span>
        </a>
        <div class="navbar-heading">Feedback Dashboard</div>
      </div>
    </nav>

    <div class="sidebar">
      <a
        href="#"
        class="sidebar-link active"
        onclick="switchTab(this, loadFeedback)"
        >Unread Messages</a
      >
      <a
        href="#"
        class="sidebar-link"
        onclick="switchTab(this, loadReadMessages)"
        >Read Messages</a
      >
    </div>

    <div class="main-content">
      <div id="feedbackList" class="row row-cols-1 row-cols-md-2 g-2"></div>
    </div>

    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-primary" id="modalUserEmail">
              Feedback from User
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p class="rating-stars fs-4 mb-2" id="modalStars"></p>
            <p id="modalMessage" class="text-muted"></p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-success" id="togglePublicBtn">
              Make Public
            </button>
            <button class="btn btn-outline-danger" id="toggleReadBtn">
              Mark as Read
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>

    <script src="credentials.js"></script>
    <script>
      const client = supabase.createClient(
        "https://pljmachiuahkrkiddehc.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsam1hY2hpdWFoa3JraWRkZWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMTAyNDEsImV4cCI6MjA2NjY4NjI0MX0.ke4EYw5lGX5DHrgu1GCDxRUbMYU-M6KzbLZVeesoVm8"
      );
      async function loadFeedback() {
        const { data, error } = await client
          .from("feedback")
          .select("*")
          .eq("read", false)
          .order("created_at", { ascending: false });
        console.log("Supabase response:", { data, error });
        renderFeedback(data, error);
      }

      async function loadReadMessages() {
        const { data, error } = await client
          .from("feedback")
          .select("*")
          .eq("read", true)
          .order("created_at", { ascending: false });
        renderFeedback(data, error);
      }

      function renderFeedback(data, error) {
        const list = document.getElementById("feedbackList");
        list.innerHTML = "";

        if (error) {
          console.error("Error loading feedback:", error);
          alert("❌ Failed to fetch feedback.");
          return;
        }

        if (!data || data.length === 0) {
          const emptyMessage = document.createElement("div");
          emptyMessage.className = "col text-center";
          emptyMessage.innerHTML = `
          <div class="card p-4 text-center text-muted" style="max-width: 500px; margin: 10px auto; padding: 60px 30px;">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">No feedback messages found.</p>
          </div>
        `;
          list.appendChild(emptyMessage);
          return;
        }

        data.forEach((entry) => {
          const card = document.createElement("div");
          card.className = "col";

          card.innerHTML = `
          <div class="card p-3">
            <h5 class="card-title text-primary">${entry.user_email}</h5>
            <p class="rating-stars fs-4 mb-2">${"★".repeat(
              entry.rating
            )}${"☆".repeat(5 - entry.rating)}</p>
            <p class="card-text truncated">${entry.message}</p>
          </div>
        `;

          card
            .querySelector(".card")
            .addEventListener("click", () => openModal(entry));
          list.appendChild(card);
        });
      }

      function openModal(entry) {
        document.getElementById("modalUserEmail").textContent =
          entry.user_email;
        document.getElementById("modalStars").textContent =
          "★".repeat(entry.rating) + "☆".repeat(5 - entry.rating);
        document.getElementById("modalMessage").textContent = entry.message;

        const toggleBtn = document.getElementById("toggleReadBtn");
        toggleBtn.textContent = entry.read ? "Mark as Unread" : "Mark as Read";
        toggleBtn.onclick = async () => {
          await client
            .from("feedback")
            .update({ read: !entry.read })
            .eq("id", entry.id);
          bootstrap.Modal.getInstance(
            document.getElementById("feedbackModal")
          ).hide();
          entry.read ? loadReadMessages() : loadFeedback();
        };

        const modal = new bootstrap.Modal(
          document.getElementById("feedbackModal")
        );
        modal.show();
      }

      function switchTab(clickedEl, callback) {
        document
          .querySelectorAll(".sidebar a")
          .forEach((a) => a.classList.remove("active"));
        clickedEl.classList.add("active");
        callback();
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const preloader = document.getElementById("preloader");
        try {
          await loadFeedback();
        } catch (err) {
          console.error(err);
        } finally {
          preloader.style.opacity = "0";
          setTimeout(() => {
            preloader.style.display = "none";
          }, 500);
        }
      });

      function openModal(entry) {
        document.getElementById("modalUserEmail").textContent =
          entry.user_email;
        document.getElementById("modalStars").textContent =
          "★".repeat(entry.rating) + "☆".repeat(5 - entry.rating);
        document.getElementById("modalMessage").textContent = entry.message;

        // Read/Unread button
        const toggleBtn = document.getElementById("toggleReadBtn");
        toggleBtn.textContent = entry.read ? "Mark as Unread" : "Mark as Read";
        toggleBtn.onclick = async () => {
          await client
            .from("feedback")
            .update({ read: !entry.read })
            .eq("id", entry.id);
          bootstrap.Modal.getInstance(
            document.getElementById("feedbackModal")
          ).hide();
          entry.read ? loadReadMessages() : loadFeedback();
        };

        // Public/Private button
        const togglePublicBtn = document.getElementById("togglePublicBtn");
        togglePublicBtn.textContent = entry.public
          ? "Make Private"
          : "Make Public";
        togglePublicBtn.onclick = async () => {
          await client
            .from("feedback")
            .update({ public: !entry.public })
            .eq("id", entry.id);

          entry.public = !entry.public; // update locally for modal toggle
          togglePublicBtn.textContent = entry.public
            ? "Make Private"
            : "Make Public";
        };

        const modal = new bootstrap.Modal(
          document.getElementById("feedbackModal")
        );
        modal.show();
      }

      function switchTab(clickedEl, callback) {
        document
          .querySelectorAll(".sidebar a")
          .forEach((a) => a.classList.remove("active"));
        clickedEl.classList.add("active");
        callback();
      }
    </script>
  </body>
</html>
