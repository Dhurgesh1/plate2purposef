<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plate2Purpose - Restaurant Dashboard</title>
    <link rel="icon" href="images/recycle-sign.png" type="image/png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Playfair+Display&family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
      body {
        font-family: "Poppins", Arial, sans-serif;
        background: #fff5f0;
        margin: 0;
        padding-top: 100px;
      }
      .navbar {
        height: 100px;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        font-family: "Playfair Display", serif;
      }
      .navbar-brand {
        font-family: "Amatic SC", cursive;
        font-size: 2.2rem;
        color: #ff5500;
      }
      .nav-link {
        font-size: 1.1rem;
        color: #333;
        margin-right: 1rem;
        transition: color 0.2s;
        font-family: "Poppins", sans-serif;
      }
      .nav-link:hover,
      .nav-link.active {
        color: #cb7575;
        font-weight: bold;
      }
      .sidebar {
        position: fixed;
        top: 110px;
        left: 20px;
        height: 650px;
        width: 230px;
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding-top: 30px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 20px 10px;
        z-index: 100;
        overflow-y: auto; /* <-- Make sidebar scrollable */
      }
      .sidebar a {
        color: #333;
        text-decoration: none;
        padding: 15px 8px;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: background 0.3s, color 0.3s;
        border-radius: 8px;
        margin: 0 10px;
        font-family: "Poppins", sans-serif;
      }
      .sidebar a:hover,
      .sidebar a.active {
        background-color: #cb7575;
        color: white;
      }
      .main {
        margin-left: 270px;
        margin-top: 80px;
        padding: 30px;
        max-width: 900px;
      }
      .section {
        display: none;
      }
      .section.active {
        display: block;
      }
      .section > .bg-white {
        border-radius: 14px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        background-color: white;
        min-height: 550px;
      }
      h2 {
        color: #cb7575;
        font-family: "Playfair Display", serif;
        margin-top: 2rem;
        margin-bottom: 1rem;
      }
      .form-control,
      .form-select {
        margin-bottom: 1rem;
      }
      .btn-theme {
        background: #cb7575;
        color: #fff;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .btn-theme:hover {
        background: #a94d4d;
      }
      .upload-box {
        border: 2px dashed #cb7575;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #fff0eb;
        margin-bottom: 2rem;
        cursor: pointer;
      }
      .upload-box:hover {
        background: #ffe5e0;
      }
      .list-group-item {
        font-family: "Poppins", sans-serif;
      }
      .copyright {
        text-align: center;
        color: #888;
        font-size: 1rem;
        background: #fff;
        margin-top: 2rem;
        border-top: 1px solid #eee;
        padding: 1rem 0;
      }
      .switch-mode-btn {
        background-color: transparent;
        color: #cb7575;
        border: 2px solid #cb7575;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: calc(100% - 40px);
        margin: 0 20px;
        font-family: "Poppins", sans-serif;
        margin-bottom: 10px;
      }
      .switch-mode-btn:hover {
        background-color: #cb7575;
        color: white;
      }
      .profile-box {
        background-color: #fff0eb;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-top: 20px;
        padding: 15px;
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-size: 14px;
        font-family: "Poppins", sans-serif;
      }
      .profile-name {
        color: #cb7575;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        width: 100%;
        font-family: "Poppins", sans-serif;
      }
      .profile-email {
        font-size: 13px;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        width: 100%;
        font-family: "Poppins", sans-serif;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg shadow-sm fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Plate2Purpose</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="dashboard2.html"
                >Restaurant Dashboard</a
              >
            </li>
            <li class="nav-item position-relative">
              <button
                id="saveBtn"
                class="btn btn-outline-primary d-flex align-items-center gap-2"
                style="font-family: 'Poppins', sans-serif; font-weight: 600"
              >
                <span
                  class="spinner-border spinner-border-sm d-none"
                  id="saveSpinner"
                  role="status"
                  aria-hidden="true"
                ></span>
                <span id="saveText">Save Changes</span>
              </button>
              <span
                id="saveFeedback"
                style="
                  position: absolute;
                  top: 100%;
                  left: 50%;
                  transform: translateX(-50%);
                  background: #cb7575;
                  color: #fff;
                  padding: 4px 16px;
                  border-radius: 8px;
                  font-size: 14px;
                  opacity: 0;
                  transition: opacity 0.3s;
                  margin-top: 4px;
                  z-index: 10;
                "
                >Saved!</span
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="sidebar">
      <a href="#" class="sidebar-link active" data-target="attendance"
        ><i class="bi bi-people-fill"></i> Attendance</a
      >
      <a href="#" class="sidebar-link" data-target="calculator"
        ><i class="bi bi-calculator"></i> Food Calculator</a
      >
      <a href="#" class="sidebar-link" data-target="payments"
        ><i class="bi bi-credit-card"></i> UPI Payments</a
      >
      <a href="#" class="sidebar-link" data-target="menu"
        ><i class="bi bi-list"></i> Menu & Recipes</a
      >
      <a href="#" class="sidebar-link" data-target="bulk"
        ><i class="bi bi-box-seam"></i> Bulk Orders</a
      >
      <a href="#" class="sidebar-link" data-target="preorder"
        ><i class="bi bi-clock-history"></i> Pre-Orders</a
      >
      <a href="#" class="sidebar-link" data-target="reservations"
        ><i class="bi bi-calendar-check"></i> Reservations</a
      >
      <a href="#" class="sidebar-link" data-target="feedback"
        ><i class="bi bi-chat-dots"></i> Feedback</a
      >
      <button class="switch-mode-btn" id="modeSwitchBtn" onclick="switchMode()">
        Switch Mode
      </button>
      <div
        class="profile-box text-center mx-3 p-3 mt-auto"
        style="cursor: pointer"
      >
        <div class="profile-name fw-semibold" id="profileNameDisplay">
          Dhurgesh Maloth
        </div>
        <div class="profile-email text-muted small" id="profileEmailDisplay">
          malothdhurgesh@gmail.com
        </div>
        <button
          class="btn btn-outline-danger btn-sm mt-2 w-100"
          id="logoutBtn"
          onclick="logout(); event.stopPropagation();"
        >
          Logout
        </button>
      </div>
    </div>

    <div class="main">
      <!-- Attendance Section -->
      <div id="attendance" class="section active">
        <div class="bg-white">
          <h2>Attendance Tracking</h2>
          <div class="mb-3">
            <input
              type="text"
              id="studentName"
              placeholder="Enter guest name"
              class="form-control mb-2"
            />
            <button class="btn btn-primary mt-2" onclick="addStudent()">
              Add Guest
            </button>
          </div>
          <div
            class="upload-box"
            onclick="document.getElementById('attendanceExcel').click();"
          >
            <i
              class="bi bi-cloud-arrow-up"
              style="font-size: 2rem; color: #cb7575"
            ></i>
            <p>Upload Excel for Attendance</p>
            <input
              type="file"
              id="attendanceExcel"
              style="display: none"
              accept=".xlsx,.xls"
            />
          </div>
          <ul id="studentList" class="list-group"></ul>
        </div>
      </div>

      <!-- Food Calculator Section -->
      <div id="calculator" class="section">
        <div class="bg-white">
          <h2>Food Calculator</h2>
          <button class="btn btn-primary mb-3" onclick="calculateFood()">
            Calculate
          </button>
          <div id="calculatorResult"></div>
        </div>
      </div>

      <!-- UPI Payments Section -->
      <div id="payments" class="section">
        <div class="bg-white">
          <h2>UPI Payments</h2>
          <p>Feature: track and display UPI-based payments.</p>
        </div>
      </div>

      <!-- Menu & Recipes Section -->
      <div id="menu" class="section">
        <div class="bg-white">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Menu & Recipes</h2>
            <div class="btn-group">
              <button
                id="chooseBtn"
                class="btn btn-outline-success"
                onclick="setRecipeMode('choose')"
              >
                Choose Recipes
              </button>
              <button
                id="editBtn"
                class="btn btn-outline-warning"
                onclick="setRecipeMode('edit')"
              >
                Edit Recipes
              </button>
            </div>
          </div>
          <div
            class="upload-box"
            onclick="document.getElementById('menuExcel').click();"
          >
            <i
              class="bi bi-cloud-arrow-up"
              style="font-size: 2rem; color: #cb7575"
            ></i>
            <p>Upload Excel for Menu & Recipes</p>
            <input
              type="file"
              id="menuExcel"
              style="display: none"
              accept=".xlsx,.xls"
            />
          </div>
          <div class="mb-3">
            <input
              type="text"
              id="recipeName"
              class="form-control mb-2"
              placeholder="Recipe Name"
            />
            <div class="d-flex gap-2 mb-2">
              <input
                type="text"
                id="ingredientName"
                class="form-control"
                placeholder="Ingredient Name"
              />
              <input
                type="text"
                id="ingredientQty"
                class="form-control"
                placeholder="Quantity"
              />
              <button
                class="btn btn-outline-secondary"
                onclick="addTempIngredient()"
              >
                ➕ Add Ingredient
              </button>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="checkbox"
                id="mealBreak"
                value="Break"
              />
              <label class="form-check-label">Breakfast</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="checkbox"
                id="mealLunch"
                value="Lunch"
              />
              <label class="form-check-label">Lunch</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="checkbox"
                id="mealDinner"
                value="Dinner"
              />
              <label class="form-check-label">Dinner</label>
            </div>
            <ul id="ingredientPreview" class="list-group mb-3"></ul>
            <button class="btn btn-success" onclick="addRecipe()">
              Add Recipe
            </button>
          </div>
          <ul id="menuList" class="list-group"></ul>
        </div>
      </div>

      <!-- Bulk Orders Section -->
      <div id="bulk" class="section">
        <div class="bg-white">
          <h2>Bulk Orders</h2>
          <div
            class="upload-box"
            onclick="document.getElementById('bulkExcel').click();"
          >
            <i
              class="bi bi-cloud-arrow-up"
              style="font-size: 2rem; color: #cb7575"
            ></i>
            <p>Upload Excel for Bulk Orders</p>
            <input
              type="file"
              id="bulkExcel"
              style="display: none"
              accept=".xlsx,.xls"
            />
          </div>
          <form id="bulk-order-form">
            <input
              type="text"
              class="form-control"
              id="bulk-name"
              name="bulk-name"
              placeholder="Name"
              required
            />
            <input
              type="number"
              class="form-control"
              id="bulk-quantity"
              name="bulk-quantity"
              min="1"
              placeholder="Quantity"
              required
            />
            <input
              type="text"
              class="form-control"
              id="bulk-item"
              name="bulk-item"
              placeholder="Menu Item"
              required
            />
            <button type="submit" class="btn-theme">Place Bulk Order</button>
          </form>
          <ul id="bulk-list" class="list-group"></ul>
          <div
            id="bulk-success"
            style="display: none"
            class="mt-2 text-success"
          >
            Bulk order placed!
          </div>
        </div>
      </div>

      <!-- Pre-Orders Section -->
      <div id="preorder" class="section">
        <div class="bg-white">
          <h2>Pre-Orders</h2>
          <div
            class="upload-box"
            onclick="document.getElementById('preExcel').click();"
          >
            <i
              class="bi bi-cloud-arrow-up"
              style="font-size: 2rem; color: #cb7575"
            ></i>
            <p>Upload Excel for Pre-Orders</p>
            <input
              type="file"
              id="preExcel"
              style="display: none"
              accept=".xlsx,.xls"
            />
          </div>
          <form id="pre-order-form">
            <input
              type="text"
              class="form-control"
              id="pre-order-name"
              name="pre-order-name"
              placeholder="Name"
              required
            />
            <input
              type="text"
              class="form-control"
              id="pre-order-item"
              name="pre-order-item"
              placeholder="Menu Item"
              required
            />
            <input
              type="date"
              class="form-control"
              id="pre-order-date"
              name="pre-order-date"
              required
            />
            <button type="submit" class="btn-theme">Pre-Order</button>
          </form>
          <ul id="pre-list" class="list-group"></ul>
          <div
            id="preorder-success"
            style="display: none"
            class="mt-2 text-success"
          >
            Pre-order successful!
          </div>
        </div>
      </div>

      <!-- Reservations Section -->
      <div id="reservations" class="section">
        <div class="bg-white">
          <h2>Reservations</h2>
          <form id="reservation-form" class="mb-3">
            <input
              type="text"
              class="form-control mb-2"
              id="reservation-name"
              placeholder="Your Name"
              required
            />
            <input
              type="number"
              class="form-control mb-2"
              id="reservation-seats"
              min="1"
              placeholder="Number of Seats"
              required
            />
            <input
              type="datetime-local"
              class="form-control mb-2"
              id="reservation-datetime"
              required
            />
            <button type="submit" class="btn-theme">Book Reservation</button>
          </form>
          <ul id="reservation-list" class="list-group"></ul>
          <div
            id="reservation-success"
            style="display: none"
            class="mt-2 text-success"
          >
            Reservation booked!
          </div>
        </div>
      </div>

      <!-- Feedback Section -->
      <div id="feedback" class="section">
        <div class="bg-white">
          <h2>Feedback</h2>
          <div class="mb-3">
            <label class="form-label">Your Rating:</label>
            <div id="starRating" class="d-flex gap-2">
              <i
                class="bi bi-star-fill text-secondary fs-3"
                onclick="setRating(1)"
              ></i>
              <i
                class="bi bi-star-fill text-secondary fs-3"
                onclick="setRating(2)"
              ></i>
              <i
                class="bi bi-star-fill text-secondary fs-3"
                onclick="setRating(3)"
              ></i>
              <i
                class="bi bi-star-fill text-secondary fs-3"
                onclick="setRating(4)"
              ></i>
              <i
                class="bi bi-star-fill text-secondary fs-3"
                onclick="setRating(5)"
              ></i>
            </div>
          </div>
          <div class="mb-3">
            <label for="feedbackText" class="form-label">Your Feedback:</label>
            <textarea
              class="form-control"
              id="feedbackText"
              rows="4"
              placeholder="Share your thoughts..."
            ></textarea>
          </div>
          <button class="btn btn-theme" onclick="submitFeedback()">
            Submit Feedback
          </button>
        </div>
      </div>
    </div>

    <div class="copyright">&copy; 2025 Plate2Purpose. All rights reserved.</div>

    <script>
      // LocalStorage keys
      const LS_KEYS = {
        students: "dashboard2_students",
        recipes: "dashboard2_recipes",
        bulkOrders: "dashboard2_bulkOrders",
        preOrders: "dashboard2_preOrders",
        reservations: "dashboard2_reservations",
      };

      // Global arrays (will be initialized by loadDashboardData)
      let students = [];
      let recipes = [];
      let bulkOrders = [];
      let preOrders = [];
      let reservations = [];
      let tempIngredients = [];
      let recipeMode = "choose";
      let selectedRecipeIndexes = [];

      // Load data from localStorage
      function loadDashboardData() {
        students = JSON.parse(localStorage.getItem(LS_KEYS.students) || "[]");
        recipes = JSON.parse(localStorage.getItem(LS_KEYS.recipes) || "[]");
        bulkOrders = JSON.parse(
          localStorage.getItem(LS_KEYS.bulkOrders) || "[]"
        );
        preOrders = JSON.parse(localStorage.getItem(LS_KEYS.preOrders) || "[]");
        reservations = JSON.parse(
          localStorage.getItem(LS_KEYS.reservations) || "[]"
        );
        renderStudents();
        renderRecipes();
        renderBulkOrders();
        renderPreOrders();
        renderReservations();
      }

      // Save all arrays to localStorage
      function saveDashboardData() {
        localStorage.setItem(LS_KEYS.students, JSON.stringify(students));
        localStorage.setItem(LS_KEYS.recipes, JSON.stringify(recipes));
        localStorage.setItem(LS_KEYS.bulkOrders, JSON.stringify(bulkOrders));
        localStorage.setItem(LS_KEYS.preOrders, JSON.stringify(preOrders));
        localStorage.setItem(
          LS_KEYS.reservations,
          JSON.stringify(reservations)
        );
      }

      // Immediately load data on page open
      loadDashboardData();

      // Attendance logic
      function addStudent() {
        const name = document.getElementById("studentName").value.trim();
        if (!name) return;
        students.push({ name, present: false });
        document.getElementById("studentName").value = "";
        renderStudents();
        saveDashboardData();
      }
      function renderStudents() {
        const list = document.getElementById("studentList");
        list.innerHTML = "";
        students.forEach((student, i) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<span>${student.name}</span>
          <div>
            <button class="btn btn-sm ${
              student.present ? "btn-success" : "btn-outline-danger"
            }" onclick="toggleAttendance(${i})">${
            student.present ? "Present" : "Absent"
          }</button>
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteStudent(${i})"><i class="bi bi-trash"></i></button>
          </div>`;
          list.appendChild(li);
        });
      }
      function toggleAttendance(i) {
        students[i].present = !students[i].present;
        renderStudents();
        saveDashboardData();
      }
      function deleteStudent(i) {
        students.splice(i, 1);
        renderStudents();
        saveDashboardData();
      }

      // Recipes/Menu logic
      function setRecipeMode(mode) {
        recipeMode = mode;
        renderRecipes();
        const chooseBtn = document.getElementById("chooseBtn");
        const editBtn = document.getElementById("editBtn");
        chooseBtn.classList.remove("btn-success", "text-white");
        chooseBtn.classList.add("btn-outline-success");
        editBtn.classList.remove("btn-warning", "text-dark");
        editBtn.classList.add("btn-outline-warning");
        if (mode === "choose") {
          chooseBtn.classList.remove("btn-outline-success");
          chooseBtn.classList.add("btn-success", "text-white");
        } else if (mode === "edit") {
          editBtn.classList.remove("btn-outline-warning");
          editBtn.classList.add("btn-warning", "text-dark");
        }
      }
      function addTempIngredient() {
        const name = document.getElementById("ingredientName").value.trim();
        const qty = document.getElementById("ingredientQty").value.trim();
        if (!name || !qty) return;
        tempIngredients.push({ name, qty });
        document.getElementById("ingredientName").value = "";
        document.getElementById("ingredientQty").value = "";
        renderIngredientPreview();
      }
      function renderIngredientPreview() {
        const list = document.getElementById("ingredientPreview");
        list.innerHTML = "";
        tempIngredients.forEach((item, index) => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between";
          li.innerHTML = `<span>${item.name} - ${item.qty}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="removeTempIngredient(${index})">✖</button>`;
          list.appendChild(li);
        });
      }
      function removeTempIngredient(index) {
        tempIngredients.splice(index, 1);
        renderIngredientPreview();
      }
      function addRecipe() {
        const name = document.getElementById("recipeName").value.trim();
        const meals = [];
        if (document.getElementById("mealBreak").checked)
          meals.push("Breakfast");
        if (document.getElementById("mealLunch").checked) meals.push("Lunch");
        if (document.getElementById("mealDinner").checked) meals.push("Dinner");
        if (!name || tempIngredients.length === 0 || meals.length === 0) return;
        recipes.push({ name, ingredients: [...tempIngredients], meals });
        document.getElementById("recipeName").value = "";
        document.getElementById("mealBreak").checked = false;
        document.getElementById("mealLunch").checked = false;
        document.getElementById("mealDinner").checked = false;
        tempIngredients = [];
        renderIngredientPreview();
        renderRecipes();
        saveDashboardData();
      }
      function renderRecipes() {
        const list = document.getElementById("menuList");
        list.innerHTML = "";
        recipes.forEach((recipe, i) => {
          // FIX: Use backticks for template string inside map
          const ingList = recipe.ingredients
            .map((ing) => `${ing.name}: ${ing.qty}`)
            .join(", ");
          const mealList = recipe.meals.join(", ");
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          if (recipeMode === "choose") {
            li.innerHTML = `<span><strong>${
              recipe.name
            }</strong> (${mealList})<br><small>${ingList}</small></span>
            <input type="checkbox" class="form-check-input" id="choose-checkbox-${i}" ${
              selectedRecipeIndexes.includes(i) ? "checked" : ""
            } onclick="toggleRecipeSelection(${i})">`;
          } else {
            li.innerHTML = `<span><strong>${recipe.name}</strong> (${mealList})<br><small>${ingList}</small></span>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteRecipe(${i})"><i class="bi bi-trash"></i></button>`;
          }
          list.appendChild(li);
        });
      }
      function deleteRecipe(i) {
        recipes.splice(i, 1);
        renderRecipes();
        saveDashboardData();
      }
      function toggleRecipeSelection(index) {
        // FIX: Reference id as a string
        const checkbox = document.getElementById(`choose-checkbox-${index}`);
        checkbox.checked = !checkbox.checked;
        if (checkbox.checked) {
          if (!selectedRecipeIndexes.includes(index)) {
            selectedRecipeIndexes.push(index);
          }
        } else {
          selectedRecipeIndexes = selectedRecipeIndexes.filter(
            (i) => i !== index
          );
        }
      }

      // Bulk Orders logic
      document
        .getElementById("bulk-order-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const name = document.getElementById("bulk-name").value;
          const qty = document.getElementById("bulk-quantity").value;
          const item = document.getElementById("bulk-item").value;
          bulkOrders.push({ name, qty, item });
          renderBulkOrders();
          document.getElementById("bulk-success").style.display = "block";
          setTimeout(() => {
            document.getElementById("bulk-success").style.display = "none";
            e.target.reset();
          }, 2000);
          saveDashboardData();
        });
      function renderBulkOrders() {
        const list = document.getElementById("bulk-list");
        list.innerHTML = "";
        bulkOrders.forEach((order, i) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<span>${order.name} - ${order.qty} x ${order.item}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteBulkOrder(${i})"><i class="bi bi-trash"></i></button>`;
          list.appendChild(li);
        });
      }
      function deleteBulkOrder(i) {
        bulkOrders.splice(i, 1);
        renderBulkOrders();
        saveDashboardData();
      }

      // Pre-Orders logic
      document
        .getElementById("pre-order-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const name = document.getElementById("pre-order-name").value;
          const item = document.getElementById("pre-order-item").value;
          const date = document.getElementById("pre-order-date").value;
          preOrders.push({ name, item, date });
          renderPreOrders();
          document.getElementById("preorder-success").style.display = "block";
          setTimeout(() => {
            document.getElementById("preorder-success").style.display = "none";
            e.target.reset();
          }, 2000);
          saveDashboardData();
        });
      function renderPreOrders() {
        const list = document.getElementById("pre-list");
        list.innerHTML = "";
        preOrders.forEach((order, i) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<span>${order.name} - ${order.item} for ${order.date}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="deletePreOrder(${i})"><i class="bi bi-trash"></i></button>`;
          list.appendChild(li);
        });
      }
      function deletePreOrder(i) {
        preOrders.splice(i, 1);
        renderPreOrders();
        saveDashboardData();
      }

      // Reservations logic
      document
        .getElementById("reservation-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const name = document.getElementById("reservation-name").value.trim();
          const seats = document.getElementById("reservation-seats").value;
          const datetime = document.getElementById(
            "reservation-datetime"
          ).value;
          if (!name || !seats || !datetime) return;
          reservations.push({ name, seats, datetime });
          renderReservations();
          document.getElementById("reservation-success").style.display =
            "block";
          setTimeout(() => {
            document.getElementById("reservation-success").style.display =
              "none";
            e.target.reset();
          }, 2000);
          saveDashboardData();
        });
      function renderReservations() {
        const list = document.getElementById("reservation-list");
        list.innerHTML = "";
        reservations.forEach((r, i) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<span>${r.name} - ${r.seats} seat(s) at ${new Date(
            r.datetime
          ).toLocaleString()}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteReservation(${i})"><i class="bi bi-trash"></i></button>`;
          list.appendChild(li);
        });
      }
      function deleteReservation(i) {
        reservations.splice(i, 1);
        renderReservations();
        saveDashboardData();
      }

      // Feedback logic
      let selectedRating = 0;
      function setRating(rating) {
        selectedRating = rating;
        const stars = document.querySelectorAll("#starRating i");
        stars.forEach((star, index) => {
          star.classList.remove("text-warning");
          star.classList.add("text-secondary");
          if (index < rating) {
            star.classList.remove("text-secondary");
            star.classList.add("text-warning");
          }
        });
      }
      function submitFeedback() {
        const feedbackText = document
          .getElementById("feedbackText")
          .value.trim();
        if (selectedRating === 0 || feedbackText === "") {
          alert("Please provide both a rating and feedback.");
          return;
        }
        alert("✅ Feedback submitted! Thank you.");
        setRating(0);
        document.getElementById("feedbackText").value = "";
      }

      // Excel upload handlers
      function handleExcelUpload(inputId, type) {
        document
          .getElementById(inputId)
          .addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
              const data = new Uint8Array(ev.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              const json = XLSX.utils.sheet_to_json(sheet);
              if (type === "attendance") {
                students = json.map((row) => ({
                  name: row.Name || "",
                  present: (row.Status || "").toLowerCase() === "present",
                }));
                renderStudents(); // <-- Immediately show attendance data
              } else if (type === "menu") {
                recipes = json.map((row) => ({
                  name: row.Recipe || row.Name || "",
                  ingredients: row.Ingredients
                    ? row.Ingredients.split(",").map((ing) => {
                        const [name, qty] = ing.split(":");
                        return {
                          name: name?.trim() || "",
                          qty: qty?.trim() || "",
                        };
                      })
                    : [],
                  meals: row.Meals
                    ? row.Meals.split(",").map((m) => m.trim())
                    : [],
                }));
                renderRecipes(); // <-- Immediately show menu data
              } else if (type === "bulk") {
                bulkOrders = json.map((row) => ({
                  name: row.Name || "",
                  qty: row.Quantity || "",
                  item: row.Item || "",
                }));
                renderBulkOrders(); // <-- Immediately show bulk orders
              } else if (type === "pre") {
                preOrders = json.map((row) => ({
                  name: row.Name || "",
                  item: row.Item || "",
                  date: row.Date || "",
                }));
                renderPreOrders(); // <-- Immediately show pre-orders
              }
            };
            reader.readAsArrayBuffer(file);
          });
      }
      handleExcelUpload("attendanceExcel", "attendance");
      handleExcelUpload("menuExcel", "menu");
      handleExcelUpload("bulkExcel", "bulk");
      handleExcelUpload("preExcel", "pre");

      // Switch Mode logic
      function switchMode() {
        const currentPage = window.location.pathname;
        if (currentPage.includes("dashboard2.html")) {
          window.location.href = "dashboard.html";
        } else {
          window.location.href = "dashboard2.html";
        }
        // After navigation, load data
        setTimeout(() => {
          loadDashboardData();
        }, 500);
      }
      window.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("modeSwitchBtn");
        if (btn) {
          btn.innerText = "Switch Mode";
        }
      });

      // Save Changes button logic
      document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById("saveBtn");
        const spinner = document.getElementById("saveSpinner");
        const text = document.getElementById("saveText");
        const feedback = document.getElementById("saveFeedback");

        if (btn) {
          btn.addEventListener("click", () => {
            spinner.classList.remove("d-none");
            text.textContent = "Saving...";
            saveDashboardData();
            spinner.classList.add("d-none");
            text.textContent = "Saved";
            if (feedback) {
              feedback.style.opacity = "1";
              setTimeout(() => {
                feedback.style.opacity = "0";
                text.textContent = "Save Changes";
              }, 2000);
            } else {
              setTimeout(() => {
                text.textContent = "Save Changes";
              }, 2000);
            }
          });
        }
      });

      // Sidebar navigation (move to end, after all DOM is loaded)
      document.addEventListener("DOMContentLoaded", function () {
        const links = document.querySelectorAll(".sidebar-link");
        const sections = document.querySelectorAll(".section");
        links.forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            links.forEach((l) => l.classList.remove("active"));
            link.classList.add("active");
            const target = link.getAttribute("data-target");
            sections.forEach((section) => {
              section.classList.remove("active");
              if (section.id === target) section.classList.add("active");
            });
          });
        });
      });
    </script>
  </body>
</html>
